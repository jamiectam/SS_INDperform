---
title: "Untitled"
author: "Jamie C Tam"
date: "8/10/2021"
output: html_document
---

## set up libraries
```{r setup, include=FALSE}
library(DT)
library(mgcv)
library(tidyverse)
library(MARSS)
library(reshape2)
# require(meboot)
library(ggplot2)
library(INDperform)
library(grid)
library (gridExtra)
library (GGally)
```



## set up data for both WSS/ESS long/short
```{r cars}
path <- file.path("C:/Users/tamj/Documents/JCT work/SS Ecosystem Report/SS-Ecosystem-Report/Thresholds/data")

# import enviro trends
enviro.inds <- read.csv(paste(path, "/enviro_trends.csv", sep = ""), stringsAsFactors = FALSE)      # standardized

# import disaggregated enviro trends

env.inds.d<-read.csv(paste(path, "/SS_environmental_indicators.csv", sep= ""), stringsAsFactors = FALSE)

# import indicators (ecological + fishing)
inds <- read.csv(paste(path, "/eco_indicators_esswss.csv", sep = ""), stringsAsFactors = FALSE)

# responses (from final set in Tech Report)
# need to add BIOMASS_INVERTEBRATES and BIOMASS_TL2 for short period


long.response.names<-c("MargalefRichness_ALL", 
                    "Heips_ALL",
                    "LargeFishIndicator",
                    "BIOMASS_PISCIVORE",
                    "BIOMASS_ZOOPISCIVORE",
                    "MeanLengthABUNDANCE" ,
                    "MeanTLCommunity" ,
                    "CCondition_FINFISH",
                    "CCondition_MBENTHIVORE",
                    "CCondition_PISCIVORE",
                    "CCondition_ZOOPISCIVORE",
                    "CCondition_LBENTHIVORE",
                    "MeanLifespan" ,
                    "IVILandings",
                    "CVBiomass" ,
                    "BIOMASS_ALL",
                    "BIOMASS_GADOIDS" ,
                    "BIOMASS_FLATFISH",
                    "BIOMASS_SKATES")

short.response.names <- c("MargalefRichness_ALL", 
                    "Heips_ALL",
                    "LargeFishIndicator",
                    "BIOMASS_PISCIVORE",
                    "BIOMASS_ZOOPISCIVORE",
                    "MeanLengthABUNDANCE" ,
                    "MeanTLCommunity" ,
                    "CCondition_FINFISH",
                    "CCondition_MBENTHIVORE",
                    "CCondition_PISCIVORE",
                    "CCondition_ZOOPISCIVORE",
                    "CCondition_LBENTHIVORE",
                    "MeanLifespan" ,
                    "IVILandings",
                    "CVBiomass" ,
                    "BIOMASS_ALL",
                    "BIOMASS_GADOIDS" ,
                    "BIOMASS_FLATFISH",
                    "BIOMASS_SKATES", 
                    "BIOMASS_INVERTEBRATES", 
                    "INVERTEBRATES_GROUNDFISH", 
                    "BIOMASS_TL2")

short.responses <- inds[, c("YEAR", "ID", short.response.names)]
long.responses<-inds[, c("YEAR", "ID", long.response.names)]

# Pressures (from final set in Tech Report)
FP <- c("FP_ALL",
        "FP_CLUPEIDS",
        "MeanTL.Landings",
        "MTI.Landings_3.25",
        "DiversityTargetSpp_ALL",
        "landings_ALL",
        "landings_SKATES.L",
        "landings_FLATFISH.L",
        "landings_LARGE_PELAGIC.L",
        "FP_INVERTEBRATES")

FP.inds <- inds[, c("YEAR", "ID", FP)]

#change Diversity to number 
FP.inds$DiversityTargetSpp_ALL<-as.numeric(FP.inds$DiversityTargetSpp_ALL)

# merge fishing and environmental pressures and re-order and re-name for clarity
environ.inds<-full_join(enviro.inds, env.inds.d, by=c("ID", "YEAR"), copy=FALSE)

pressures <- full_join(environ.inds, FP.inds, by = c("ID", "YEAR")) 
long.pressures<- dplyr::select(pressures, "YEAR", "ID",
                           "MAFA1", "MAFA2", 
                           "Diversity_Target_Spp" = "DiversityTargetSpp_ALL",
                           "MeanTL_Landings" = "MeanTL.Landings",
                           "MTI" = "MTI.Landings_3.25",
                           "Fishing_Pressure" = "FP_ALL",
                           "FP_Clupeids" = "FP_CLUPEIDS",
                           "Skates_Landings" = "landings_SKATES.L",
                           "Flatfish_Landings" = "landings_FLATFISH.L",
                           "Large_Pelagic_Landings" = "landings_LARGE_PELAGIC.L" ,
                           "Total_Landings" = "landings_ALL",
                           "Air_Temperature", "AMO", "CIL_Volume", "Density", "Ice_Area", "Ice_Volume",
                           "NAO_Winter", "Salinity", "Stratification", "Bottom_Temp", "Bottom_Temp_Shelf")

long.pressures1<- dplyr::select(pressures, "YEAR", "ID",
                           
                           "Diversity_Target_Spp" = "DiversityTargetSpp_ALL",
                           "MeanTL_Landings" = "MeanTL.Landings",
                           "MTI" = "MTI.Landings_3.25",
                           "Fishing_Pressure" = "FP_ALL",
                           "FP_Clupeids" = "FP_CLUPEIDS",
                           "Skates_Landings" = "landings_SKATES.L",
                           "Flatfish_Landings" = "landings_FLATFISH.L",
                           "Large_Pelagic_Landings" = "landings_LARGE_PELAGIC.L" ,
                           "Total_Landings" = "landings_ALL")

long.pressures2<- dplyr::select(pressures, "YEAR", "ID",
                           "MAFA1", "MAFA2", 
                           
                           "Air_Temperature", "AMO", "CIL_Volume", "Density", "Ice_Area", "Ice_Volume",
                           "NAO_Winter", "Salinity", "Stratification", "Bottom_Temp", "Bottom_Temp_Shelf")
                    

short.pressures <- dplyr::select(pressures, "YEAR", "ID",
                           "MAFA1", "MAFA2",
                           "DFA1", "DFA2", "DFA3",
                           "Diversity_Target_Spp" = "DiversityTargetSpp_ALL",
                           "MeanTL_Landings" = "MeanTL.Landings",
                           "MTI" = "MTI.Landings_3.25",
                           "Fishing_Pressure" = "FP_ALL",
                           "FP_Clupeids" = "FP_CLUPEIDS",
                           "Skates_Landings" = "landings_SKATES.L",
                           "Flatfish_Landings" = "landings_FLATFISH.L",
                           "Large_Pelagic_Landings" = "landings_LARGE_PELAGIC.L" ,
                           "Total_Landings" = "landings_ALL",
                           "Air_Temperature",
                           "AMO", 
                           "CIL_Volume", 
                           "Density", 
                           "Ice_Area", 
                           "Ice_Volume",
                           "NAO_Winter", 
                           "Salinity", 
                           "Stratification", 
                           "Bottom_Temp", 
                           "Bottom_Temp_Shelf",
                           "SST", 
                           "Nitrate_0_50", 
                           "Silicate_0_50", 
                           "Phosphate_0_50",
                           "Nitrate_50_150", 
                           "Silicate_50_150", 
                           "Phosphate_50_150",
                           "Chlorophyll_100m", 
                           "C_finmarchicus", 
                           "Pseudocalanus", 
                           "Copepods", 
                           "Non_copepods", 
                           "Zooplankton_Biomass", 
                           "Diatoms", 
                           "Dinoflagellates",
                           "Ciliates", 
                           "Flagellates", 
                           "Larvacea", 
                           "Euphausiacea", 
                           "Gastropoda",
                           "Chaetognatha",
                           "Polychaeta", 
                           "Ostracoda", 
                           "Bivalvia", 
                           "Echinodermata", 
                           "Cirripedia", 
                           "Amphipoda", 
                           "Arctic_Calanus", 
                           "Warm_Offshore", 
                           "Warm_Shelf", 
                           "Bloom_Start",
                           "Bloom_Duration", 
                           "Bloom_Amplitude", 
                           "Bloom_Magnitude")

short.pressures1 <- dplyr::select(pressures, "YEAR", "ID",
                
                           "Diversity_Target_Spp" = "DiversityTargetSpp_ALL",
                           "MeanTL_Landings" = "MeanTL.Landings",
                           "MTI" = "MTI.Landings_3.25",
                           "Fishing_Pressure" = "FP_ALL",
                           "FP_Clupeids" = "FP_CLUPEIDS",
                           "Skates_Landings" = "landings_SKATES.L",
                           "Flatfish_Landings" = "landings_FLATFISH.L",
                           "Large_Pelagic_Landings" = "landings_LARGE_PELAGIC.L" ,
                           "Total_Landings" = "landings_ALL",
                           "Air_Temperature",
                           "AMO", 
                           "CIL_Volume", 
                           "Density", 
                           "Ice_Area", 
                           "Ice_Volume",
                           "NAO_Winter", 
                           "Salinity", 
                           "Stratification", 
                           "Bottom_Temp", 
                           "Bottom_Temp_Shelf",
                           "SST")

short.pressures2 <- dplyr::select(pressures, "YEAR", "ID", "MAFA1", "MAFA2",
                           "DFA1", "DFA2", "DFA3",
                            "Nitrate_0_50",
                           "Silicate_0_50",
                           "Phosphate_0_50",
                           "Nitrate_50_150",
                           "Silicate_50_150",
                           "Phosphate_50_150",
                           "Chlorophyll_100m",
                           "C_finmarchicus",
                           "Pseudocalanus",
                           "Copepods",
                           "Non_copepods",
                           "Zooplankton_Biomass",
                           "Diatoms",
                           "Dinoflagellates",
                           "Ciliates",
                           "Flagellates",
                           "Larvacea",
                           "Euphausiacea",
                           "Gastropoda",
                           "Chaetognatha",
                           "Polychaeta",
                           "Ostracoda",
                           "Bivalvia",
                           "Echinodermata",
                           "Cirripedia",
                           "Amphipoda",
                           "Arctic_Calanus",
                           "Warm_Offshore",
                           "Warm_Shelf",
                           "Bloom_Start",
                           "Bloom_Duration",
                           "Bloom_Amplitude",
                           "Bloom_Magnitude")
long.pressure.names <- names(long.pressures)[3:length(names(long.pressures))]
short.pressure.names <- names(short.pressures)[3:length(names(short.pressures))]
#responses
#pressures

```
## look at trends
```{r}
# wss.long.resp<-long.responses %>% 
#   dplyr::filter(ID=="WSS") %>%
#   as_tibble()
# 
# wss.long.press<-long.pressures %>% 
#   dplyr::filter(ID=="WSS") %>%
#   as_tibble()

wss.long.all.wide<-cbind(wss.long.responses, wss.long.pressures)

wss.long.a<-ggpairs(wss.long.all.wide)
# Turn them both to long form and merge them
# wss.long.all <- gather(wss.long.resp,var,value,-ID,-YEAR) %>% 
#   left_join(gather(wss.long.press,var,value,-ID,-YEAR),by="ID")
# 
# ggplot(data = wss.long.all,aes(x = value.x,y=value.y)) +
#   geom_point() +
#   facet_grid(var.x~var.y)

```


##  WSS short
```{r}
#set up data for WSS short
wss.short.responses<-short.responses %>% 
  dplyr::filter(ID=="WSS", YEAR >=1999) %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

wss.short.pressures<-short.pressures %>%
  dplyr::filter(ID=="WSS", YEAR >=1999) %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()


wss.short.year<-short.pressures %>%
  dplyr::filter(ID=="WSS", YEAR>=1999) %>%
  dplyr::select(YEAR)

wss.short.year$YEAR<-as.numeric(wss.short.year$YEAR)
wss.short.year<-dplyr::pull(wss.short.year, YEAR)



wss.short.ts.trend<-model_trend(ind_tbl=wss.short.responses, time=wss.short.year)
# wss.short.ts.trend.pd<-plot_diagnostics(wss.short.ts.trend$model)
# wss.short.ts.trend.pt<-plot_diagnostics(wss.short.ts.trend$model)

#initilization of the data
wss.short.data_init<-ind_init(ind_tbl=wss.short.responses, press_tbl=wss.short.pressures, time=wss.short.year)

#GAM and GAMM for wss.short

wss.short.m_gam<-model_gam(init_tbl=wss.short.data_init)
wss.short.m_glm1<-model_gam(init_tbl=wss.short.data_init, k=1)
save(wss.short.m_glm1, file="wss.short.m_glm1.RData")

# p.wss.short<-plot_model(init_tbl=wss.short.data_init, mod_tbl=wss.short.m_gam)

wss.short.m_gamm<-model_gamm(init_tbl=wss.short.data_init, filter=wss.short.m_gam$tac, excl_outlier=NULL)

wss.short.best_gamm<-select_model(gam_tbl=wss.short.m_gam, gamm_tbl=wss.short.m_gamm)

#save(wss.short.m_gam, file="wss.short.m_gam.RData")
#derivatives
wss.short.calc<-calc_deriv(init_tbl=wss.short.data_init, mod_tbl=wss.short.best_gamm)

#pressure indicators

wss.short.it<-select_interaction(mod_tbl=wss.short.calc)

wss.short.m_all_2<-test_interaction(init_tbl=wss.short.data_init, mod_tbl=wss.short.calc, interactions=wss.short.it)
save(wss.short.m_all1, file="wss.short.m_all1.RData")
write_csv(wss.short.m_all_2, "wss.short.m_all_2.csv")
```


# WSS long
```{r}
#set up data for WSS long
wss.long.responses<-long.responses %>% 
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

wss.long.pressures<-long.pressures %>% 
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

wss.long.year<-long.pressures1 %>%
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(YEAR)

wss.long.year$YEAR<-as.numeric(wss.long.year$YEAR)
wss.long.year<-dplyr::pull(wss.long.year, YEAR)

wss.long.ts.trend<-model_trend(ind_tbl=wss.long.responses, time=wss.long.year)
# wss.long.ts.trend.pd<-plot_diagnostics(wss.long.ts.trend$BIOMASS_ALL)


#Data initialization
wss.long.data_init<-ind_init(ind_tbl=wss.long.responses, press_tbl=wss.long.pressures, time=wss.long.year)

#GAM and GAMMs
wss.long.m_gam<-model_gam(init_tbl=wss.long.data_init)
wss.long.m_glm1<-model_gam(init_tbl=wss.long.data_init, k=1)
save(wss.long.m_glm1, file="wss.long.m_glm1.RData")

# p.wss.long<-plot_model(init_tbl=wss.long.data_init, mod_tbl=wss.long.m_gam)

wss.long.m_gamm<-model_gamm(init_tbl=wss.long.data_init, filter=wss.long.m_gam$tac, excl_outlier=NULL)

wss.long.best_gamm<-select_model(gam_tbl=wss.long.m_gam, gamm_tbl=wss.long.m_gamm)

save(wss.long.ts.trend, file="wss.long.ts.trend2.RData")
save(wss.long.m_gam, file="wss.long.m_gam2.RData")
save(wss.long.m_gamm, file="wss.long.m_gamm2.RData")
save(wss.long.best_gamm, file="wss.short.best_gamm2.RData")

#Derivatives of wss.long
wss.long.calc<-calc_deriv(init_tbl=wss.long.data_init, mod_tbl=wss.long.best_gamm)

#pressure indicators wss.long
wss.long.it<-select_interaction(mod_tbl=wss.long.calc)

wss.long.m_all2<-test_interaction(init_tbl=wss.long.data_init, mod_tbl=wss.long.calc, interactions=wss.long.it)

write_csv(wss.long.m_all2, "wss.long.m_all2.csv")
save(wss.long.m_all2, file="wss.long.m_all2.RData")
save(wss.long.m_all1, file="wss.long.m_all1.RData")

```

### Explore plots wss.long
```{r}
wss.long.responses<-long.responses %>% 
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

wss.long.pressures<-long.pressures %>% 
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

wss.long.year<-long.pressures %>%
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(YEAR) %>%
  as_vector

#data_init is not the same ID order as wss.long.m_all, and the plots do not line up! shit

wss.long.data_init<-ind_init(ind_tbl=wss.long.responses, press_tbl=wss.long.pressures, time=wss.long.year)
wss.long.data_init_combo<-

wss.long.m_all<-rbind(wss.long.m_all1, wss.long.m_all2)%>%
              select(-id) %>%
              filter(!(ind=="MargalefRichness_ALL")) %>%
              arrange(ind)%>%
              add_column(id=1:164)
             
#pull thesholds
wss.long.m_all_thresh<-wss.long.m_all %>%
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)

# wss.long.p<-plot_model(init_tbl=wss.long.data_init, mod_tbl=wss.long.m_all)

# wss.long.p$all_plots[[31]]

#make threshold plots
wss.long.thresh.p<-plot_model(init_tbl=wss.long.data_init, mod_tbl=wss.long.m_all_thresh)

wss.long.thresh.p$response_plot[[4]]

#make threshold grid plots
gridExtra::grid.arrange(nrow=7, grobs=wss.long.thresh.p$response_plot[1:21])
```


# ESS long
```{r}
#set up data for ESS long
ess.long.responses<-long.responses %>% 
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

ess.long.pressures<-long.pressures1 %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

ess.long.year<-long.pressures1 %>%
   dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(YEAR)

ess.long.year$YEAR<-as.numeric(ess.long.year$YEAR)
ess.long.year<-dplyr::pull(ess.long.year, YEAR)



ess.long.ts.trend<-model_trend(ind_tbl=ess.long.responses, time=ess.long.year)
# ess.long.ts.trend.pd<-plot_diagnostics(ess.long.ts.trend$model)
# 
# ess.long.ts.trend<-model_trend(ind_tbl=ess.long.responses, time=ess.long.year)
###ess.long.ts.trend.pd<-plot_diagnostics(ess.long.ts.trend$model)


#Data initialization
ess.long.data_init<-ind_init(ind_tbl=ess.long.responses, press_tbl=ess.long.pressures, time=ess.long.year)

#GAM and GAMMs
ess.long.m_gam<-model_gam(init_tbl=ess.long.data_init)
ess.long.m_glm1<-model_gam(init_tbl=ess.long.data_init, k=1)

# p.ess.long<-plot_model(init_tbl=ess.long.data_init, mod_tbl=ess.long.m_gam)

ess.long.m_gamm<-model_gamm(init_tbl=ess.long.data_init, filter=ess.long.m_gam$tac, excl_outlier=NULL)

ess.long.best_gamm<-select_model(gam_tbl=ess.long.m_gam, gamm_tbl=ess.long.m_gamm)


save(ess.long.ts.trend, file="ess.long.ts.trend2.RData")
save(ess.long.m_gam, file="ess.long.m_gam2.RData")
save(ess.long.m_gamm, file="ess.long.m_gamm2.RData")
save(ess.long.best_gamm, file="ess.short.best_gamm2.RData")

#Derivatives of ess.long
ess.long.calc<-calc_deriv(init_tbl=ess.long.data_init, mod_tbl=ess.long.m_gam)

#pressure indicators ess.long
ess.long.it<-select_interaction(mod_tbl=ess.long.calc)

ess.long.m_all2<-test_interaction(init_tbl=ess.long.data_init, mod_tbl=ess.long.calc, interactions=ess.long.it)

write_csv(ess.long.m_all2, "ess.long.m_all2.csv")
save(ess.long.m_all2, file="ess.long.m_all2.RData")
save(ess.long.m_glm1, file="ess.long.m_glm1.RData")
```

### Explore plots ess.long
```{r}
load("ess.long.m_all1.RData")
load("ess.long.m_all2.RData")

ess.long.responses<-long.responses %>% 
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

ess.long.pressures1<-long.pressures1 %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

ess.long.year1<-long.pressures1 %>%
   dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(YEAR)%>%
  as_vector()

ess.long.pressures2<-long.pressures2 %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

ess.long.year2<-long.pressures2 %>%
   dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(YEAR)%>%
  as_vector()


#data_init is not the same ID order as wss.long.m_all, and the plots do not line up! shit

ess.long.data_init2<-ind_init(ind_tbl=ess.long.responses, press_tbl=ess.long.pressures2, time=ess.long.year2)


# ess.long.m_all<-rbind(wss.long.m_all1, wss.long.m_all2)%>%
#               select(-id) %>%
#               filter(!(ind=="MargalefRichness_ALL")) %>%
#               arrange(ind)%>%
#               add_column(id=1:164)
             
#pull thesholds
# ess.long.m_all_thresh1<-ess.long.m_all1 %>%
#                   dplyr::filter(interaction== "TRUE", na.rm=TRUE)

# wss.long.p<-plot_model(init_tbl=wss.long.data_init, mod_tbl=wss.long.m_all)

# wss.long.p$all_plots[[31]]

#make plots
ess.long.2.p<-plot_model(init_tbl=ess.long.data_init2, mod_tbl=ess.long.m_all2)

ess.long.2.p$all_plots[[1]]

ess.long.1.FPclup.p<-ess.long.1.p %>% filter(press=="FP_Clupeids")
ess.long.1.FP.p<-ess.long.1.p %>% filter(press=="Fishing_Pressure")
ess.long.1.FP_d.p<-ess.long.1.p %>%  filter(press=="Fishing_Pressure") %>% filter(!is.na(deriv_plot))

ess.long.1.MTLL.p<-ess.long.1.p %>% filter(press=="MeanTL_Landings")
ess.long.1.MTLL_d.p<-ess.long.1.p %>%  filter(press=="MeanTL_Landings") %>% filter(!is.na(deriv_plot))

ess.long.2.BT.p<-ess.long.2.p %>% filter(press=="Bottom_Temp")
ess.long.2.BT_d.p<-ess.long.2.p %>%  filter(press=="Bottom_temp") %>% filter(!is.na(deriv_plot))
ess.long.BT_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.long.2.BT.p$response_plot[2:19])

ess.long.2.AMO.p<-ess.long.2.p %>% filter(press=="AMO")
ess.long.2.AMO_d.p<-ess.long.2.p %>%  filter(press=="AMO") %>% filter(!is.na(deriv_plot))
ess.long.AMO_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.long.2.AMO.p$response_plot[2:19])

#make threshold grid plots
ess.long.FP_clup_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.long.1.FPclup.p$response_plot[2:19])
ess.long.FP_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.long.1.FP.p$response_plot[2:19])
ess.long.MTLL_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.long.1.MTLL.p$response_plot[2:19])
ess.long.1.FP.p$deriv_plot[[4]]
ess.long.FP_d_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.long.1.FP.p$deriv_plot[2:14])
ggsave(file="ess.long.FP_clup_resp_plot.pdf", ess.long.FP_clup_resp_plot)
```

#  ESS short
```{r}
ess.short.responses<-short.responses %>% 
  dplyr::filter(ID=="ESS", YEAR>=1999) %>%
  dplyr::select(-YEAR, -ID)

ess.short.pressures<-short.pressures1 %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS", YEAR>=1999) %>%
  dplyr::select(-YEAR, -ID)


ess.short.year<-short.pressures1 %>%
  dplyr::slice(-98) %>%  
  dplyr::filter(ID=="ESS", YEAR>=1999) %>%
  dplyr::select(YEAR)


ess.short.year$YEAR<-as.numeric(ess.short.year$YEAR)
ess.short.year<-dplyr::pull(ess.short.year, YEAR)


ess.short.ts.trend<-model_trend(ind_tbl=ess.short.responses, time=ess.short.year)
# ess.short.ts.trend.pd<-plot_diagnostics(ess.short.ts.trend$model)
# ess.short.ts.trend.pt<-plot_diagnostics(ess.short.ts.trend$model)

#Data initialization
ess.short.data_init<-ind_init(ind_tbl=ess.short.responses, press_tbl=ess.short.pressures, time=ess.short.year)

#GAM and GAMMs
ess.short.m_gam<-model_gam(init_tbl=ess.short.data_init)
ess.short.m_glm1<-model_gam(init_tbl=ess.short.data_init, k=1)
save(ess.short.m_glm1, file="ess.short.m_glm1.RData")

# p.ess.short<-plot_model(init_tbl=ess.short.data_init, mod_tbl=ess.short.m_gam)

ess.short.m_gamm<-model_gamm(init_tbl=ess.short.data_init, filter=ess.short.m_gam$tac, excl_outlier=NULL)

ess.short.best_gamm<-select_model(gam_tbl=ess.short.m_gam, gamm_tbl=ess.short.m_gamm)

save(ess.short.m_gam, file="ess.short.m_gam2.RData")
save(ess.short.m_gamm, file="ess.short.m_gamm2.RData")
save(ess.short.best_gamm, file="ess.short.best_gamm2.RData")

#Derivatives of ess.short
ess.short.calc<-calc_deriv(init_tbl=ess.short.data_init, mod_tbl=ess.short.best_gamm)

#pressure indicators ess.long
ess.short.it<-select_interaction(mod_tbl=ess.short.calc)

ess.short.m_all2<-test_interaction(init_tbl=ess.short.data_init, mod_tbl=ess.short.calc, interactions=ess.short.it)

write_csv(ess.short.m_all2, "ess.short.m_all2.csv")
```

### Explore plots ess.short
```{r}
load("ess.short.m_all1.RData")
load("ess.short.m_all2.RData")

ess.short.responses<-short.responses %>% 
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

ess.short.pressures1<-short.pressures1 %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

ess.short.year1<-short.pressures1 %>%
   dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(YEAR)%>%
  as_vector()

ess.short.pressures2<-short.pressures2 %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

ess.short.year2<-short.pressures2 %>%
   dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(YEAR)%>%
  as_vector()


#data_init is not the same ID order as wss.long.m_all, and the plots do not line up! shit

ess.short.data_init1<-ind_init(ind_tbl=ess.short.responses, press_tbl=ess.short.pressures1, time=ess.short.year1)

ess.short.data_init2<-ind_init(ind_tbl=ess.short.responses, press_tbl=ess.short.pressures2, time=ess.short.year2)



#make plots
ess.short.1.p<-plot_model(init_tbl=ess.short.data_init1, mod_tbl=ess.short.m_all1)
ess.short.2.p<-plot_model(init_tbl=ess.short.data_init2, mod_tbl=ess.short.m_all2)

ess.short.2.p$all_plots[[3]]

ess.short.1.FPclup.p<-ess.short.1.p %>% filter(press=="FP_Clupeids")
ess.short.1.FP.p<-ess.short.1.p %>% filter(press=="Fishing_Pressure")
ess.short.1.FP_d.p<-ess.short.1.p %>%  filter(press=="Fishing_Pressure") %>% filter(!is.na(deriv_plot))

ess.short.1.MTLL.p<-ess.short.1.p %>% filter(press=="MeanTL_Landings")
ess.short.1.MTLL_d.p<-ess.short.1.p %>%  filter(press=="MeanTL_Landings") %>% filter(!is.na(deriv_plot))

ess.short.2.BT.p<-ess.short.2.p %>% filter(press=="Bottom_Temp")
ess.short.2.BT_d.p<-ess.short.2.p %>%  filter(press=="Bottom_temp") %>% filter(!is.na(deriv_plot))
ess.short.BT_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.short.2.BT.p$response_plot[2:19])

ess.short.2.AMO.p<-ess.short.2.p %>% filter(press=="AMO")
ess.short.2.AMO_d.p<-ess.short.2.p %>%  filter(press=="AMO") %>% filter(!is.na(deriv_plot))
ess.short.AMO_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.short.2.AMO.p$response_plot[2:19])

#make threshold grid plots
ess.short.FP_clup_resp_plot<-gridExtra::grid.arrange(nrow=3, grobs=ess.short.1.FPclup.p$response_plot[2:6])
ess.short.FP_resp_plot<-gridExtra::grid.arrange(nrow=4, grobs=ess.short.1.FP.p$response_plot[1:8])
ess.short.MTLL_resp_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.short.1.MTLL.p$response_plot[2:19])
ess.long.1.FP.p$deriv_plot[[4]]
ess.long.FP_d_plot<-gridExtra::grid.arrange(nrow=5, grobs=ess.long.1.FP.p$deriv_plot[2:14])
ggsave(file="ess.long.FP_clup_resp_plot.pdf", ess.long.FP_clup_resp_plot)
```

##GLMs
```{r}
library(meboot)
library(mgcv)
library(reshape2)

#set up data for WSS short
wss.short.responses<-short.responses %>% 
  dplyr::filter(ID=="WSS", YEAR >=1999) %>%
  dplyr::select(-YEAR, -ID)%>%
  as.data.frame()

wss.short.pressures<-short.pressures %>%
  dplyr::filter(ID=="WSS", YEAR >=1999) %>%
  dplyr::select(-YEAR, -ID) %>%
  as.data.frame()


wss.short.year<-short.pressures %>%
  dplyr::filter(ID=="WSS", YEAR>=1999) %>%
  dplyr::select(YEAR)
# 
# wss.short.year$YEAR<-as.numeric(wss.short.year$YEAR)
# wss.short.year<-dplyr::pull(wss.short.year, YEAR)

dat.full <- cbind(wss.short.responses, wss.short.pressures, wss.short.year)
#
resp.name <- colnames(wss.short.responses)
dri.name <- colnames(wss.short.pressures)
#
dat.cut <- dat.full[colnames(dat.full) %in% c("YEAR", resp.name, dri.name)]
dat.cut <- dat.cut[apply(dat.cut, 1, function(x)!any(is.na(x))),]

myresponse <- dat.cut[[resp.name]]
mydriver <- dat.cut[[dri.name]]
ts.length <- dat.cut$YEAR

#####################
# Fit the GAM model #
#####################
sp.len <- 200 # Spline length
nb <- 1000  # Number of bootstrap replicates
gam.mat <- matrix(nrow=sp.len, ncol=nb) ## create a matrix to be filled with bootstrapped splines (200 x 1000)
# dif1 <- 1 # First derivative
# dif2 <- 2 # Second derivative
# #
# GAM #
# gam1 <- gam(myresponse ~ s(mydriver, bs = "ts"), method = "GCV.Cp", se = T)
# gam1 uses thin-plate splines and prevents overfitting by using cross validation, run 
# ?gam() for more info on model. 
# summary(gam1) will show the summary statistics for the model
# gam.check(gam1)
# plot(gam1) will show a plot of the model

# GLM #
gam1 <- gam(myresponse ~ mydriver, method="GCV.Cp", select=TRUE)
# gam2 removes the smoothing function s(), so it is basically a linear model. Check out my paper to see the conditions
# on when to pick a GAM over a GLM... although for your data I imagine that GAM will be best.
# gam.check(gam2)

# Pull out relevant model outputs:
summary.gam1 <- as.data.frame(cbind(summary(gam1)$dev.expl,       # deviance explained
                                    summary(gam1)$edf,            # estimated degrees of freedom
                                    summary(gam1)$sp.criterion,   # GCV score
                                    summary(gam1)$s.pv))          # estimated p-value
colnames(summary.gam1)<-c("dev.expl","edf", "GCV", "p_value")

ind.fit <- list(mydriver = seq(from = min(mydriver), to = max(mydriver), length.out = sp.len))
pred <- predict.gam(gam1, newdata = ind.fit, type = "response", se.fit = T)
#
gam.data <- data.frame(pred$fit,
                       ind.fit$mydriver)
colnames(gam.data) <- c("response","driver")

# Bootstrap and subsequent code in a nutshell...
# 1) take a random sample of the data 1000 times
# 2) take GAM of each bootstrap replicate (br)
# 3) Take the 1st and 2nd derivative of each br
# 4) When 95% of the 1st or 2nd derivative replicates are greater or less than zero, we have a significant
#    trend (1st derivative), or threshold (2nd derivative).
#
# Note on maximum entropy bootstrap:
# Bootstrapping is a nonparametric alternative for assessing the 
# uncertainty of a linear trend in the presence
# of autocorrelation. Maximum entropy bootstrap allows
# us to construct a set of replicates of the original series
# to be used for inference while retaining the temporal
# dependence structure of the original series in the resampling process
#
respboot <- meboot(myresponse, reps = nb, trim = 0.1)$ens 
drivboot <- meboot(mydriver, reps = nb, trim = 0.1)$ens
#
gam.mat <- matrix(ncol = nb, nrow = sp.len)
for(i in 1:nb) {
  resp.i <- respboot[,i]
  driv.i <- drivboot[,i]
  gam.i <- gam(resp.i ~ s(driv.i, bs = "ts"), method = "GCV.Cp", se = T)
  newdata.i <- list(driv.i = seq(from = min(driv.i), 
                                 to = max(driv.i),
                                 length.out = sp.len))
  gam.mat[,i] <- predict.gam(gam.i, newdata = newdata.i, type = "response", se.fit = T)$fit
}
#


```

```{r}
# create pressure for the GAM forumla
  press <- paste( pressure.names, sep  = "")
  
  # forumla for GAM
  mods <- expand.grid(response.names, press, stringsAsFactors = FALSE)
  names(mods) <- c("response", "press")
  mods$formula <- paste(mods$response, mods$press, sep = " ~ ")
  
  # initialize list and dataframe to store results
  #model.results <- list(NULL)
  model.summary <- data.frame()
  
  # loop over each formula in mods
  for(i in 1:nrow(mods)){
    
    gam.i <- gam(as.formula(mods$formula[i]), data = ess.dat, 
                 method = "REML",
                 family = family.ess)
    
    # store the results for each model
    #model.results[[i]] <- gam.i
    
    # store the summary for each model
    model.summary.i <- data.frame(as.character(mods$response[i]),
                                  as.character(mods$smooth[i]),
                                  signif(summary(gam.i)$s.pv, digits = 2),
                                  round(summary(gam.i)$edf, digits = 2),
                                  round(summary(gam.i)$r.sq, digits = 2),
                                  round(summary(gam.i)$dev.expl, digits = 3))
    names(model.summary.i) = c("response", "smooth", "p-value", "edf", "r-squared", "deviance explained")
    
    model.summary <- rbind(model.summary, model.summary.i)
  }
  
```
## GLM for wss.short


```{r}

wss.short.responses<-short.responses %>% 
  dplyr::filter(ID=="WSS", YEAR >=1999) %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

wss.short.pressures<-short.pressures %>%
  dplyr::filter(ID=="WSS", YEAR >=1999) %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()


wss.short.year<-short.pressures %>%
  dplyr::filter(ID=="WSS", YEAR>=1999) %>%
  dplyr::select(YEAR)

dat.full<-cbind(wss.short.responses, wss.short.pressures, wss.short.year)

resp <- c(rep(c("MargalefRichness_ALL", 
                    "Heips_ALL",
                    "LargeFishIndicator",
                    "BIOMASS_PISCIVORE",
                    "BIOMASS_ZOOPISCIVORE",
                    "MeanLengthABUNDANCE" ,
                    "MeanTLCommunity" ,
                    "CCondition_FINFISH",
                    "CCondition_MBENTHIVORE",
                    "CCondition_PISCIVORE",
                    "CCondition_ZOOPISCIVORE",
                    "CCondition_LBENTHIVORE",
                    "MeanLifespan" ,
                    "IVILandings",
                    "CVBiomass" ,
                    "BIOMASS_ALL",
                    "BIOMASS_GADOIDS" ,
                    "BIOMASS_FLATFISH",
                    "BIOMASS_SKATES", 
                    "BIOMASS_INVERTEBRATES", 
                    "INVERTEBRATES_GROUNDFISH", 
                    "BIOMASS_TL2"), 59))

dri <- c(rep(c( "MAFA1", "MAFA2",
                           "DFA1", "DFA2", "DFA3",
                           "Diversity_Target_Spp",
                           "MeanTL_Landings" ,
                           "MTI",
                           "Fishing_Pressure" ,
                           "FP_Clupeids" ,
                           "Skates_Landings" ,
                           "Flatfish_Landings" ,
                           "Large_Pelagic_Landings"  ,
                           "Total_Landings" ,
                           "Air_Temperature",
                           "AMO", 
                           "CIL_Volume", 
                           "Density", 
                           "Ice_Area", 
                           "Ice_Volume",
                           "NAO_Winter", 
                           "Salinity", 
                           "Stratification", 
                           "Bottom_Temp", 
                           "Bottom_Temp_Shelf",
                           "SST", 
                           "Nitrate_0_50", 
                           "Silicate_0_50", 
                           "Phosphate_0_50",
                           "Nitrate_50_150", 
                           "Silicate_50_150", 
                           "Phosphate_50_150",
                           "Chlorophyll_100m", 
                           "C_finmarchicus", 
                           "Pseudocalanus", 
                           "Copepods", 
                           "Non_copepods", 
                           "Zooplankton_Biomass", 
                           "Diatoms", 
                           "Dinoflagellates",
                           "Ciliates", 
                           "Flagellates", 
                           "Larvacea", 
                           "Euphausiacea", 
                           "Gastropoda",
                           "Chaetognatha",
                           "Polychaeta", 
                           "Ostracoda", 
                           "Bivalvia", 
                           "Echinodermata", 
                           "Cirripedia", 
                           "Amphipoda", 
                           "Arctic_Calanus", 
                           "Warm_Offshore", 
                           "Warm_Shelf", 
                           "Bloom_Start",
                           "Bloom_Duration", 
                           "Bloom_Amplitude", 
                           "Bloom_Magnitude"), 22))
         

#
# gamFunc <- function(RESPONSE, DRIVER) {
#resp.name <- "California_sea_lion_pup_production" 
#dri.name <- "Nutrients"

# for(resp.name in resp) {
#   for(dri.name in dri) {
#     cat(paste0(resp.name, " ", dri.name, "\n"))
#     gamFunction(resp.name = resp.name, dri.name = dri.name)
#   }
# }
allSummary <- data.frame()
#
# gamFunction(resp.name = resp.name, dri.name = dri.name)

# gamFunction <- function(resp.name, dri.name) 
for (imod in 1:length(resp))
  {
  #imod=1
#for(resp.name in resp) {
  #for(dri.name in dri) {
   resp.name <- resp[imod]
   dri.name <- dri[imod]
  
    dat.cut <- dat.full[colnames(dat.full) %in% c("YEAR", resp.name, dri.name)]
    dat.cut <- dat.cut[apply(dat.cut, 1, function(x)!any(is.na(x))),]
    #
    myresponse <- dat.cut[[resp.name]]
    mydriver <- dat.cut[[dri.name]]
    ts.length <- dat.cut$year
    #
    #####################
    # Fit the GAM model #
    #####################
    sp.len <- 200 # Spline length
    nb <- 1000  # Number of bootstrap replicates
    gam.mat <- matrix(nrow=sp.len, ncol=nb) ## create a matrix to be filled with bootstrapped splines (200 x 1000)
    dif1 <- 1 # First derivative
    dif2 <- 2 # Second derivative
    ks <- 4
    # ks <- ifelse(dri.name == "Nutrients", 3, 4)
    #
    # GAM #
#    gam1 <- gam(myresponse ~ s(mydriver, bs = "tp", k = ks), method = "GCV.Cp", se = T)
#    gam1 <- gam(myresponse ~ s(mydriver, k = ks), method = "ML", se = T)
#    gamm1 <- gamm(myresponse ~ s(mydriver, bs = "tp", k = ks), 
#           se = T,correlation=corAR1(form=~ts.length))
   # gamm(myresponse ~ s(mydriver, bs= "tp",k = ks), optimMmethod="GCV.Cp",
            # se = T,correlation=corAR1(form=~ts.length)))
    #myresponse <- c(myresponse,0.23,0.21)
    #mydriver <- c(mydriver,26500000,26400000)
    #myresponse <- c(myresponse,myresponse)
    #mydriver <- c(mydriver,mydriver)
    

    try(gam1 <- glm(myresponse ~ mydriver))
    if (length(gam1)==0)
      {
       print(imod)
       gam1 <- gam(myresponse~mydriver, method="GCV.Cp", se=T)
      }

    # gam1 uses thin-plate splines and prevents overfitting by using cross validation, run 
    # ?gam() for more info on model. 
    # summary(gam1) will show the summary statistics for the model
    # gam.check(gam1)
    # plot(gam1) will show a plot of the model
    
    # GLM #
    #gam2 <- gam(myresponse ~ mydriver, method = "GCV.Cp", se = T)
    #gam2 <- gamm(myresponse ~ s(mydriver,k=1), method = "ML", se = T,correlation=corAR1())
    #gam2 <- gls(myresponse ~ mydriver, method = "ML", correlation=corAR1())

# gam2 removes the smoothing function s(), so it is basically a linear model. Check out my paper to see the conditions
    # on when to pick a GAM over a GLM... although for your data I imagine that GAM will be best.
    # gam.check(gam2)
    r2glm <- function(gam1) {

  summaryLog <- summary(gam1)
  1 - summaryLog$deviance / summaryLog$null.deviance

}
    # # Pull out relevant model outputs:
    summary.gam1 <- as.data.frame(cbind("GLM",                        # Model name
                                        resp.name,                    # Response variable
                                        dri.name,                     # Pressure variable
                                        # AIC(gam1$gam),                   # AICc
                                        gam1$aic,
                                        summary(gam1)$deviance,
                                        r2glm(gam1),
                                        # deviance explained
                                        # gam1$edf,            # estimated degrees of freedom
                                        # summary(gam1)$sp.criterion,   # GCV score
                                        coef(summary(gam1))[2,4]))       # p-value
    #
#    summary.gam2 <- as.data.frame(cbind("LM",                         # Model name
#                                        resp.name,                    # Response variable 
#                                        dri.name,                     # Pressure variable
#                                        AICc(gam2),                   # AICc
#                                        summary(gam2)$dev.expl,       # deviance explained
#                                        NA,                           # estimated degrees of freedom
#                                        summary(gam2)$sp.criterion,   # GCV score
#                                        NA))  #GCV score              # p-value
    
# colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
#colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "logLik", "edf", "Pvalue")
#colnames(summary.gam2)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
colnames(summary.gam1)<-c("model_type", "ind", "press", "glm_AICc", "glm_dev.expl","glm_rsq", "glm_Pvalue")
    
    allSummary <- rbind(allSummary, summary.gam1) #, summary.gam2)
  #} # resp.name loop
#} # dri.name loop

} ##imod loop (relevant combinations of driver/responses)

#allSummary[,c(4:8)] <- apply(allSummary[,c(4:8)], 2, function(x) as.numeric(as.character(x)))
bestList <- allSummary  #[!is.na(allSummary$edf) &
                        # allSummary$edf > 1 &
                        # allSummary$Pvalue < 0.05,]
write.table(allSummary,file='wss.short.glm_summary',row.names=FALSE)
write.csv(allSummary,'wss.short.glm_summary.csv',row.names=F)
```

#GLM ess.short
```{r}

ess.short.responses<-short.responses %>% 
  dplyr::filter(ID=="ESS", YEAR>=1999) %>%
  dplyr::select(-YEAR, -ID)

ess.short.pressures<-short.pressures %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS", YEAR>=1999) %>%
  dplyr::select(-YEAR, -ID)


ess.short.year<-short.pressures %>%
  dplyr::slice(-98) %>%  
  dplyr::filter(ID=="ESS", YEAR>=1999) %>%
  dplyr::select(YEAR)

dat.full<-cbind(ess.short.responses, ess.short.pressures, ess.short.year)

resp <- c(rep(c("MargalefRichness_ALL", 
                    "Heips_ALL",
                    "LargeFishIndicator",
                    "BIOMASS_PISCIVORE",
                    "BIOMASS_ZOOPISCIVORE",
                    "MeanLengthABUNDANCE" ,
                    "MeanTLCommunity" ,
                    "CCondition_FINFISH",
                    "CCondition_MBENTHIVORE",
                    "CCondition_PISCIVORE",
                    "CCondition_ZOOPISCIVORE",
                    "CCondition_LBENTHIVORE",
                    "MeanLifespan" ,
                    "IVILandings",
                    "CVBiomass" ,
                    "BIOMASS_ALL",
                    "BIOMASS_GADOIDS" ,
                    "BIOMASS_FLATFISH",
                    "BIOMASS_SKATES", 
                    "BIOMASS_INVERTEBRATES", 
                    "INVERTEBRATES_GROUNDFISH", 
                    "BIOMASS_TL2"), 59))

dri <- c(rep(c( "MAFA1", "MAFA2",
                           "DFA1", "DFA2", "DFA3",
                           "Diversity_Target_Spp" ,
                           "MeanTL_Landings",
                           "MTI",
                           "Fishing_Pressure" ,
                           "FP_Clupeids" ,
                           "Skates_Landings" ,
                           "Flatfish_Landings" ,
                           "Large_Pelagic_Landings" ,
                           "Total_Landings" ,
                           "Air_Temperature",
                           "AMO", 
                           "CIL_Volume", 
                           "Density", 
                           "Ice_Area", 
                           "Ice_Volume",
                           "NAO_Winter", 
                           "Salinity", 
                           "Stratification", 
                           "Bottom_Temp", 
                           "Bottom_Temp_Shelf",
                           "SST", 
                           "Nitrate_0_50", 
                           "Silicate_0_50", 
                           "Phosphate_0_50",
                           "Nitrate_50_150", 
                           "Silicate_50_150", 
                           "Phosphate_50_150",
                           "Chlorophyll_100m", 
                           "C_finmarchicus", 
                           "Pseudocalanus", 
                           "Copepods", 
                           "Non_copepods", 
                           "Zooplankton_Biomass", 
                           "Diatoms", 
                           "Dinoflagellates",
                           "Ciliates", 
                           "Flagellates", 
                           "Larvacea", 
                           "Euphausiacea", 
                           "Gastropoda",
                           "Chaetognatha",
                           "Polychaeta", 
                           "Ostracoda", 
                           "Bivalvia", 
                           "Echinodermata", 
                           "Cirripedia", 
                           "Amphipoda", 
                           "Arctic_Calanus", 
                           "Warm_Offshore", 
                           "Warm_Shelf", 
                           "Bloom_Start",
                           "Bloom_Duration", 
                           "Bloom_Amplitude", 
                           "Bloom_Magnitude"), 22))
         

#
# gamFunc <- function(RESPONSE, DRIVER) {
#resp.name <- "California_sea_lion_pup_production" 
#dri.name <- "Nutrients"

# for(resp.name in resp) {
#   for(dri.name in dri) {
#     cat(paste0(resp.name, " ", dri.name, "\n"))
#     gamFunction(resp.name = resp.name, dri.name = dri.name)
#   }
# }
allSummary <- data.frame()
#
# gamFunction(resp.name = resp.name, dri.name = dri.name)

# gamFunction <- function(resp.name, dri.name) 
for (imod in 1:length(resp))
  {
  #imod=1
#for(resp.name in resp) {
  #for(dri.name in dri) {
   resp.name <- resp[imod]
   dri.name <- dri[imod]
  
    dat.cut <- dat.full[colnames(dat.full) %in% c("YEAR", resp.name, dri.name)]
    dat.cut <- dat.cut[apply(dat.cut, 1, function(x)!any(is.na(x))),]
    #
    myresponse <- dat.cut[[resp.name]]
    mydriver <- dat.cut[[dri.name]]
    ts.length <- dat.cut$year
    #
    #####################
    # Fit the GAM model #
    #####################
    sp.len <- 200 # Spline length
    nb <- 1000  # Number of bootstrap replicates
    gam.mat <- matrix(nrow=sp.len, ncol=nb) ## create a matrix to be filled with bootstrapped splines (200 x 1000)
    dif1 <- 1 # First derivative
    dif2 <- 2 # Second derivative
    ks <- 4
    # ks <- ifelse(dri.name == "Nutrients", 3, 4)
    #
    # GAM #
#    gam1 <- gam(myresponse ~ s(mydriver, bs = "tp", k = ks), method = "GCV.Cp", se = T)
#    gam1 <- gam(myresponse ~ s(mydriver, k = ks), method = "ML", se = T)
#    gamm1 <- gamm(myresponse ~ s(mydriver, bs = "tp", k = ks), 
#           se = T,correlation=corAR1(form=~ts.length))
   # gamm(myresponse ~ s(mydriver, bs= "tp",k = ks), optimMmethod="GCV.Cp",
            # se = T,correlation=corAR1(form=~ts.length)))
    #myresponse <- c(myresponse,0.23,0.21)
    #mydriver <- c(mydriver,26500000,26400000)
    #myresponse <- c(myresponse,myresponse)
    #mydriver <- c(mydriver,mydriver)
    

    try(gam1 <- glm(myresponse ~ mydriver))
    if (length(gam1)==0)
      {
       print(imod)
       gam1 <- gam(myresponse~mydriver, method="GCV.Cp", se=T)
      }

    # gam1 uses thin-plate splines and prevents overfitting by using cross validation, run 
    # ?gam() for more info on model. 
    # summary(gam1) will show the summary statistics for the model
    # gam.check(gam1)
    # plot(gam1) will show a plot of the model
    
    # GLM #
    #gam2 <- gam(myresponse ~ mydriver, method = "GCV.Cp", se = T)
    #gam2 <- gamm(myresponse ~ s(mydriver,k=1), method = "ML", se = T,correlation=corAR1())
    #gam2 <- gls(myresponse ~ mydriver, method = "ML", correlation=corAR1())

# gam2 removes the smoothing function s(), so it is basically a linear model. Check out my paper to see the conditions
    # on when to pick a GAM over a GLM... although for your data I imagine that GAM will be best.
    # gam.check(gam2)
    r2glm <- function(gam1) {

  summaryLog <- summary(gam1)
  1 - summaryLog$deviance / summaryLog$null.deviance

}
    # # Pull out relevant model outputs:
    summary.gam1 <- as.data.frame(cbind("GLM",                        # Model name
                                        resp.name,                    # Response variable
                                        dri.name,                     # Pressure variable
                                        # AIC(gam1$gam),                   # AICc
                                        gam1$aic,
                                        summary(gam1)$deviance,
                                        r2glm(gam1),
                                        # deviance explained
                                        # gam1$edf,            # estimated degrees of freedom
                                        # summary(gam1)$sp.criterion,   # GCV score
                                        coef(summary(gam1))[2,4]))       # p-value
    #
#    summary.gam2 <- as.data.frame(cbind("LM",                         # Model name
#                                        resp.name,                    # Response variable 
#                                        dri.name,                     # Pressure variable
#                                        AICc(gam2),                   # AICc
#                                        summary(gam2)$dev.expl,       # deviance explained
#                                        NA,                           # estimated degrees of freedom
#                                        summary(gam2)$sp.criterion,   # GCV score
#                                        NA))  #GCV score              # p-value
    
# colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
#colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "logLik", "edf", "Pvalue")
#colnames(summary.gam2)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
colnames(summary.gam1)<-c("model_type", "ind", "press", "glm_AICc", "glm_dev.expl","glm_rsq", "glm_Pvalue")
    
    allSummary <- rbind(allSummary, summary.gam1) #, summary.gam2)
  #} # resp.name loop
#} # dri.name loop

} ##imod loop (relevant combinations of driver/responses)

#allSummary[,c(4:8)] <- apply(allSummary[,c(4:8)], 2, function(x) as.numeric(as.character(x)))
bestList <- allSummary  #[!is.na(allSummary$edf) &
                        # allSummary$edf > 1 &
                        # allSummary$Pvalue < 0.05,]
write.table(allSummary,file='ess.short.glm_summary',row.names=FALSE)
write.csv(allSummary,'ess.short.glm_summary.csv',row.names=F)

```

#GLM ess.long
```{r}

ess.long.responses<-long.responses %>% 
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()

ess.long.pressures<-long.pressures %>% 
    dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

ess.long.year<-long.pressures %>%
   dplyr::slice(-98) %>%
  dplyr::filter(ID=="ESS") %>%
  dplyr::select(YEAR)


dat.full<-cbind(ess.long.responses, ess.long.pressures, ess.long.year)

resp <- c(rep(c("MargalefRichness_ALL", 
                    "Heips_ALL",
                    "LargeFishIndicator",
                    "BIOMASS_PISCIVORE",
                    "BIOMASS_ZOOPISCIVORE",
                    "MeanLengthABUNDANCE" ,
                    "MeanTLCommunity" ,
                    "CCondition_FINFISH",
                    "CCondition_MBENTHIVORE",
                    "CCondition_PISCIVORE",
                    "CCondition_ZOOPISCIVORE",
                    "CCondition_LBENTHIVORE",
                    "MeanLifespan" ,
                    "IVILandings",
                    "CVBiomass" ,
                    "BIOMASS_ALL",
                    "BIOMASS_GADOIDS" ,
                    "BIOMASS_FLATFISH",
                    "BIOMASS_SKATES"), 22))

dri <- c(rep(c ( "MAFA1", "MAFA2", 
                           "Diversity_Target_Spp",
                           "MeanTL_Landings" ,
                           "MTI",
                           "Fishing_Pressure" ,
                           "FP_Clupeids" ,
                           "Skates_Landings" ,
                           "Flatfish_Landings" ,
                           "Large_Pelagic_Landings"  ,
                           "Total_Landings" ,
                           "Air_Temperature", "AMO", "CIL_Volume", "Density", "Ice_Area", "Ice_Volume",
                           "NAO_Winter", "Salinity", "Stratification", "Bottom_Temp", "Bottom_Temp_Shelf"), 19))
         

#
# gamFunc <- function(RESPONSE, DRIVER) {
#resp.name <- "California_sea_lion_pup_production" 
#dri.name <- "Nutrients"

# for(resp.name in resp) {
#   for(dri.name in dri) {
#     cat(paste0(resp.name, " ", dri.name, "\n"))
#     gamFunction(resp.name = resp.name, dri.name = dri.name)
#   }
# }
allSummary <- data.frame()
#
# gamFunction(resp.name = resp.name, dri.name = dri.name)

# gamFunction <- function(resp.name, dri.name) 
for (imod in 1:length(resp))
  {
  #imod=1
#for(resp.name in resp) {
  #for(dri.name in dri) {
   resp.name <- resp[imod]
   dri.name <- dri[imod]
  
    dat.cut <- dat.full[colnames(dat.full) %in% c("YEAR", resp.name, dri.name)]
    dat.cut <- dat.cut[apply(dat.cut, 1, function(x)!any(is.na(x))),]
    #
    myresponse <- dat.cut[[resp.name]]
    mydriver <- dat.cut[[dri.name]]
    ts.length <- dat.cut$year
    #
    #####################
    # Fit the GAM model #
    #####################
    sp.len <- 200 # Spline length
    nb <- 1000  # Number of bootstrap replicates
    gam.mat <- matrix(nrow=sp.len, ncol=nb) ## create a matrix to be filled with bootstrapped splines (200 x 1000)
    dif1 <- 1 # First derivative
    dif2 <- 2 # Second derivative
    ks <- 4
    # ks <- ifelse(dri.name == "Nutrients", 3, 4)
    #
    # GAM #
#    gam1 <- gam(myresponse ~ s(mydriver, bs = "tp", k = ks), method = "GCV.Cp", se = T)
#    gam1 <- gam(myresponse ~ s(mydriver, k = ks), method = "ML", se = T)
#    gamm1 <- gamm(myresponse ~ s(mydriver, bs = "tp", k = ks), 
#           se = T,correlation=corAR1(form=~ts.length))
   # gamm(myresponse ~ s(mydriver, bs= "tp",k = ks), optimMmethod="GCV.Cp",
            # se = T,correlation=corAR1(form=~ts.length)))
    #myresponse <- c(myresponse,0.23,0.21)
    #mydriver <- c(mydriver,26500000,26400000)
    #myresponse <- c(myresponse,myresponse)
    #mydriver <- c(mydriver,mydriver)
    

    try(gam1 <- glm(myresponse ~ mydriver))
    if (length(gam1)==0)
      {
       print(imod)
       gam1 <- gam(myresponse~mydriver, method="GCV.Cp", se=T)
      }

    # gam1 uses thin-plate splines and prevents overfitting by using cross validation, run 
    # ?gam() for more info on model. 
    # summary(gam1) will show the summary statistics for the model
    # gam.check(gam1)
    # plot(gam1) will show a plot of the model
    
    # GLM #
    #gam2 <- gam(myresponse ~ mydriver, method = "GCV.Cp", se = T)
    #gam2 <- gamm(myresponse ~ s(mydriver,k=1), method = "ML", se = T,correlation=corAR1())
    #gam2 <- gls(myresponse ~ mydriver, method = "ML", correlation=corAR1())

# gam2 removes the smoothing function s(), so it is basically a linear model. Check out my paper to see the conditions
    # on when to pick a GAM over a GLM... although for your data I imagine that GAM will be best.
    # gam.check(gam2)
    r2glm <- function(gam1) {

  summaryLog <- summary(gam1)
  1 - summaryLog$deviance / summaryLog$null.deviance

}
    # # Pull out relevant model outputs:
    summary.gam1 <- as.data.frame(cbind("GLM",                        # Model name
                                        resp.name,                    # Response variable
                                        dri.name,                     # Pressure variable
                                        # AIC(gam1$gam),                   # AICc
                                        gam1$aic,
                                        summary(gam1)$deviance,
                                        r2glm(gam1),
                                        # deviance explained
                                        # gam1$edf,            # estimated degrees of freedom
                                        # summary(gam1)$sp.criterion,   # GCV score
                                        coef(summary(gam1))[2,4]))       # p-value
    #
#    summary.gam2 <- as.data.frame(cbind("LM",                         # Model name
#                                        resp.name,                    # Response variable 
#                                        dri.name,                     # Pressure variable
#                                        AICc(gam2),                   # AICc
#                                        summary(gam2)$dev.expl,       # deviance explained
#                                        NA,                           # estimated degrees of freedom
#                                        summary(gam2)$sp.criterion,   # GCV score
#                                        NA))  #GCV score              # p-value
    
# colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
#colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "logLik", "edf", "Pvalue")
#colnames(summary.gam2)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
colnames(summary.gam1)<-c("model_type", "ind", "press", "glm_AICc", "glm_dev.expl","glm_rsq", "glm_Pvalue")
    
    allSummary <- rbind(allSummary, summary.gam1) #, summary.gam2)
  #} # resp.name loop
#} # dri.name loop

} ##imod loop (relevant combinations of driver/responses)

#allSummary[,c(4:8)] <- apply(allSummary[,c(4:8)], 2, function(x) as.numeric(as.character(x)))
bestList <- allSummary  #[!is.na(allSummary$edf) &
                        # allSummary$edf > 1 &
                        # allSummary$Pvalue < 0.05,]
write.table(allSummary,file='ess.long.glm_summary',row.names=FALSE)
write.csv(allSummary,'ess.long.glm_summary.csv',row.names=F)

```

#GLM wss.long
```{r}

#set up data for WSS long
wss.long.responses<-long.responses %>% 
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(-YEAR, -ID)%>%
  as_tibble()
wss.long.pressures<-long.pressures %>% 
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(-YEAR, -ID) %>%
  as_tibble()

wss.long.year<-long.pressures %>%
  dplyr::filter(ID=="WSS") %>%
  dplyr::select(YEAR)


dat.full<-cbind(wss.long.responses, wss.long.pressures, wss.long.year)

resp <- c(rep(c("MargalefRichness_ALL", 
                    "Heips_ALL",
                    "LargeFishIndicator",
                    "BIOMASS_PISCIVORE",
                    "BIOMASS_ZOOPISCIVORE",
                    "MeanLengthABUNDANCE" ,
                    "MeanTLCommunity" ,
                    "CCondition_FINFISH",
                    "CCondition_MBENTHIVORE",
                    "CCondition_PISCIVORE",
                    "CCondition_ZOOPISCIVORE",
                    "CCondition_LBENTHIVORE",
                    "MeanLifespan" ,
                    "IVILandings",
                    "CVBiomass" ,
                    "BIOMASS_ALL",
                    "BIOMASS_GADOIDS" ,
                    "BIOMASS_FLATFISH",
                    "BIOMASS_SKATES"), 22))

dri <- c(rep(c ( "MAFA1", "MAFA2", 
                           "Diversity_Target_Spp" ,
                           "MeanTL_Landings",
                           "MTI",
                           "Fishing_Pressure" ,
                           "FP_Clupeids" ,
                           "Skates_Landings" ,
                           "Flatfish_Landings" ,
                           "Large_Pelagic_Landings"  ,
                           "Total_Landings" ,
                           "Air_Temperature", "AMO", "CIL_Volume", "Density", "Ice_Area", "Ice_Volume",
                           "NAO_Winter", "Salinity", "Stratification", "Bottom_Temp", "Bottom_Temp_Shelf"), 19))
         

#
# gamFunc <- function(RESPONSE, DRIVER) {
#resp.name <- "California_sea_lion_pup_production" 
#dri.name <- "Nutrients"

# for(resp.name in resp) {
#   for(dri.name in dri) {
#     cat(paste0(resp.name, " ", dri.name, "\n"))
#     gamFunction(resp.name = resp.name, dri.name = dri.name)
#   }
# }
allSummary <- data.frame()
#
# gamFunction(resp.name = resp.name, dri.name = dri.name)

# gamFunction <- function(resp.name, dri.name) 
for (imod in 1:length(resp))
  {
  #imod=1
#for(resp.name in resp) {
  #for(dri.name in dri) {
   resp.name <- resp[imod]
   dri.name <- dri[imod]
  
    dat.cut <- dat.full[colnames(dat.full) %in% c("YEAR", resp.name, dri.name)]
    dat.cut <- dat.cut[apply(dat.cut, 1, function(x)!any(is.na(x))),]
    #
    myresponse <- dat.cut[[resp.name]]
    mydriver <- dat.cut[[dri.name]]
    ts.length <- dat.cut$year
    #
    #####################
    # Fit the GAM model #
    #####################
    sp.len <- 200 # Spline length
    nb <- 1000  # Number of bootstrap replicates
    gam.mat <- matrix(nrow=sp.len, ncol=nb) ## create a matrix to be filled with bootstrapped splines (200 x 1000)
    dif1 <- 1 # First derivative
    dif2 <- 2 # Second derivative
    ks <- 4
    # ks <- ifelse(dri.name == "Nutrients", 3, 4)
    #
    # GAM #
#    gam1 <- gam(myresponse ~ s(mydriver, bs = "tp", k = ks), method = "GCV.Cp", se = T)
#    gam1 <- gam(myresponse ~ s(mydriver, k = ks), method = "ML", se = T)
#    gamm1 <- gamm(myresponse ~ s(mydriver, bs = "tp", k = ks), 
#           se = T,correlation=corAR1(form=~ts.length))
   # gamm(myresponse ~ s(mydriver, bs= "tp",k = ks), optimMmethod="GCV.Cp",
            # se = T,correlation=corAR1(form=~ts.length)))
    #myresponse <- c(myresponse,0.23,0.21)
    #mydriver <- c(mydriver,26500000,26400000)
    #myresponse <- c(myresponse,myresponse)
    #mydriver <- c(mydriver,mydriver)
    

    try(gam1 <- glm(myresponse ~ mydriver))
    if (length(gam1)==0)
      {
       print(imod)
       gam1 <- gam(myresponse~mydriver, method="GCV.Cp", se=T)
      }

    # gam1 uses thin-plate splines and prevents overfitting by using cross validation, run 
    # ?gam() for more info on model. 
    # summary(gam1) will show the summary statistics for the model
    # gam.check(gam1)
    # plot(gam1) will show a plot of the model
    
    # GLM #
    #gam2 <- gam(myresponse ~ mydriver, method = "GCV.Cp", se = T)
    #gam2 <- gamm(myresponse ~ s(mydriver,k=1), method = "ML", se = T,correlation=corAR1())
    #gam2 <- gls(myresponse ~ mydriver, method = "ML", correlation=corAR1())

# gam2 removes the smoothing function s(), so it is basically a linear model. Check out my paper to see the conditions
    # on when to pick a GAM over a GLM... although for your data I imagine that GAM will be best.
    # gam.check(gam2)
    
    r2glm <- function(gam1) {

  summaryLog <- summary(gam1)
  1 - summaryLog$deviance / summaryLog$null.deviance

}
    # # Pull out relevant model outputs:
    summary.gam1 <- as.data.frame(cbind("GLM",                        # Model name
                                        resp.name,                    # Response variable
                                        dri.name,                     # Pressure variable
                                        # AIC(gam1$gam),                   # AICc
                                        gam1$aic,
                                        summary(gam1)$deviance,
                                        r2glm(gam1),
                                        # deviance explained
                                        # gam1$edf,            # estimated degrees of freedom
                                        # summary(gam1)$sp.criterion,   # GCV score
                                        coef(summary(gam1))[2,4]))       # p-value
    #
#    summary.gam2 <- as.data.frame(cbind("LM",                         # Model name
#                                        resp.name,                    # Response variable 
#                                        dri.name,                     # Pressure variable
#                                        AICc(gam2),                   # AICc
#                                        summary(gam2)$dev.expl,       # deviance explained
#                                        NA,                           # estimated degrees of freedom
#                                        summary(gam2)$sp.criterion,   # GCV score
#                                        NA))  #GCV score              # p-value
    
# colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
#colnames(summary.gam1)<-c("MODEL", "RESPONSE", "DRIVER", "logLik", "edf", "Pvalue")
#colnames(summary.gam2)<-c("MODEL", "RESPONSE", "DRIVER", "AICc", "dev.expl","edf", "GCV", "Pvalue")
colnames(summary.gam1)<-c("model_type", "ind", "press", "glm_AICc", "glm_dev.expl","glm_rsq", "glm_Pvalue")
    
    allSummary <- rbind(allSummary, summary.gam1) #, summary.gam2)
  #} # resp.name loop
#} # dri.name loop

} ##imod loop (relevant combinations of driver/responses)

#allSummary[,c(4:8)] <- apply(allSummary[,c(4:8)], 2, function(x) as.numeric(as.character(x)))
bestList <- allSummary  #[!is.na(allSummary$edf) &
                        # allSummary$edf > 1 &
                        # allSummary$Pvalue < 0.05,]
write.table(allSummary,file='wss.long.glm_summary',row.names=FALSE)
write.csv(allSummary,'wss.long.glm_summary.csv',row.names=F)

```

## Wrangle results
```{r}
library(readr)
library(tidyverse)

###for whatever reason this code didn't work?


# ess_long_glm_summary <- read_csv("JCT work/SS Ecosystem Report/SS-Ecosystem-Report/SS_INDperform/SS_INDperform/ess.long.glm_summary.csv")
# ess_short_glm_summary <- read_csv("JCT work/SS Ecosystem Report/SS-Ecosystem-Report/SS_INDperform/SS_INDperform/ess.short.glm_summary.csv", 
#     col_types = cols(AICc = col_number(), 
#         Pvalue = col_number(), dev.expl = col_number()))
# 
# wss_long_glm_summary <- read_csv("JCT work/SS Ecosystem Report/SS-Ecosystem-Report/SS_INDperform/SS_INDperform/wss.long.glm_summary.csv", 
#     col_types = cols(AICc = col_number(), 
#         Pvalue = col_number(), dev.expl = col_number()))
# 
# wss_short_glm_summary <- read_csv("JCT work/SS Ecosystem Report/SS-Ecosystem-Report/SS_INDperform/SS_INDperform/wss.short.glm_summary.csv", 
#     col_types = cols(AICc = col_number(), 
#         Pvalue = col_number(), dev.expl = col_number()))

##set up GLM and GAM data

ess.long_glm_summary<-as_tibble(ess_long_glm_summary)
ess.short_glm_summary<-as_tibble(ess_short_glm_summary)
wss.long_glm_summary<-as_tibble(wss_long_glm_summary)
wss.short_glm_summary<-as_tibble(wss_short_glm_summary)

# names(ess.long_glm_summary)<-c ('model_type','ind', 'press', 'glm_aic', 'glm_dev.expl', 'glm_p_val')
# names(ess.short_glm_summary)<-c ('model_type', 'ind', 'press', 'glm_aic', 'glm_dev.expl', 'glm_p_val')
# names(wss.long_glm_summary)<-c ('model_type', 'ind', 'press', 'glm_aic', 'glm_dev.expl', 'glm_p_val')
# names(wss.short_glm_summary)<-c ('model_type', 'ind', 'press', 'glm_aic', 'glm_dev.expl', 'glm_p_val')

wss.long.m_all_tot<-rbind(wss.long.m_all1, wss.long.m_all2)
wss.short.m_all_tot<-rbind(wss.short.m_all, wss.short.m_all_2)
ess.long.m_all_tot<-rbind(ess.long.m_all1, ess.long.m_all2)
ess.short.m_all_tot<-rbind(ess.short.m_all1, ess.short.m_all2)

ess.long_glm_summary<-ess.long_glm_summary %>% unite("combo", ind:press, sep="-", remove=FALSE)
ess.short_glm_summary<-ess.short_glm_summary %>% unite("combo", ind:press, sep="-", remove=FALSE)
wss.long_glm_summary<-wss.long_glm_summary %>% unite("combo", ind:press, sep="-", remove=FALSE)
wss.short_glm_summary<-wss.short_glm_summary %>% unite("combo", ind:press, sep="-", remove=FALSE)

ess.long.m_all_tot<-ess.long.m_all_tot %>% unite("combo", ind:press, sep="-", remove=FALSE)
ess.short.m_all_tot<-ess.short.m_all_tot %>% unite("combo", ind:press, sep="-", remove=FALSE)
wss.long.m_all_tot<-wss.long.m_all_tot %>% unite("combo", ind:press, sep="-", remove=FALSE)
wss.short.m_all_tot<-wss.short.m_all_tot %>% unite("combo", ind:press, sep="-", remove=FALSE)

ess.long_gam_glm<-full_join(ess.long_glm_summary, ess.long.m_all_tot, by="combo")
ess.short_gam_glm<-full_join(ess.short_glm_summary, ess.short.m_all_tot, by="combo")
wss.long_gam_glm<-full_join(wss.long_glm_summary, wss.long.m_all_tot, by="combo")
wss.short_gam_glm<-full_join(wss.short_glm_summary, wss.short.m_all_tot, by="combo")

save(ess.long_gam_glm, file="ess.long_gam_glm.RData")
save(ess.short_gam_glm, file="ess.short_gam_glm.RData")
save(wss.long_gam_glm, file="wss.long_gam_glm.RData")
save(wss.short_gam_glm, file="wss.short_gam_glm.RData")

write_csv(ess.long_gam_glm, "ess.long_gam_glm.csv")
write_csv(ess.short_gam_glm, "ess.short_gam_glm.csv")
write_csv(wss.long_gam_glm, "wss.long_gam_glm.csv")
write_csv(wss.short_gam_glm, "wss.short_gam_glm.csv")
```

#Query datasets
```{r}

#USE RDATA FILES NOT CSV
load("ess.long_gam_glm.RData")
load("ess.short_gam_glm.RData")
load("wss.short_gam_glm.RData")
load("wss.long_gam_glm.RData")

##function to cbind columns with different lengths, filling with NAs
require(plyr) # requires plyr for rbind.fill()
cbind.fill <- function(...) {                                                                                                                                                       
  transpoted <- lapply(list(...),t)                                                                                                                                                 
  transpoted_dataframe <- lapply(transpoted, as.data.frame)                                                                                                                         
  return (data.frame(t(rbind.fill(transpoted_dataframe))))                                                                                                                          
} 

#remove MargalefRichness & DFA 3
ess.short.gam_glm<-ess.short_gam_glm %>% 
                dplyr::filter(ind.x !="MargalefRichness_ALL" & press.x != "DFA3")
                
ess.long.gam_glm<-ess.long_gam_glm %>% 
                dplyr::filter(ind.x !="MargalefRichness_ALL" & press.x != "DFA3")
wss.short.gam_glm<-wss.short_gam_glm %>% 
                dplyr::filter(ind.x !="MargalefRichness_ALL" & press.x != "DFA3")
wss.long.gam_glm<-wss.long_gam_glm %>% 
                dplyr::filter(ind.x !="MargalefRichness_ALL" & press.x != "DFA3")


```

###Linear fits
```{r}
# Linear fits


ess.short.l_fits<-ess.short.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05,na.rm=TRUE)%>%
                dplyr::filter(glm_rsq>0.19) %>%
                dplyr::filter(is.na(id))# %>% select(combo)
              

ess.long.l_fits<-ess.long.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05,na.rm=TRUE)%>%
                dplyr::filter(glm_rsq>0.19) %>%
                 dplyr::filter(is.na(id))#%>% select(combo)
               

wss.short.l_fits<-wss.short.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05, na.rm=TRUE)%>%
                 dplyr::filter(glm_rsq>0.019) %>%
                 dplyr::filter(is.na(id))#%>% select(combo)
               
wss.long.l_fits<-wss.long.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05,na.rm=TRUE)%>%
                dplyr::filter(glm_rsq>0.19) %>%
                 dplyr::filter(is.na(id))#%>% select(combo)
                
ess.short.l_fits_combo<-ess.short.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05,na.rm=TRUE)%>%
                dplyr::filter(glm_rsq>0.19) %>%
                dplyr::filter(is.na(id)) %>% select(combo)
              

ess.long.l_fits_combo<-ess.long.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05,na.rm=TRUE)%>%
                dplyr::filter(glm_rsq>0.19) %>%
                 dplyr::filter(is.na(id)) %>% select(combo)
               

wss.short.l_fits_combo<-wss.short.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05, na.rm=TRUE)%>%
                 dplyr::filter(glm_rsq>0.019) %>%
                 dplyr::filter(is.na(id)) %>% select(combo)
               
wss.long.l_fits_combo<-wss.long.gam_glm %>%
                dplyr::filter(glm_Pvalue < 0.05,na.rm=TRUE)%>%
                dplyr::filter(glm_rsq>0.19) %>%
                 dplyr::filter(is.na(id)) %>% select(combo)

SS.l_fits<-cbind.fill(ess.short.l_fits_combo, ess.long.l_fits_combo, wss.short.l_fits_combo, wss.long.l_fits_combo)

SS.names<-c("ess.short", "ess.long", "wss.short", "wss.long")
colnames(SS.l_fits)<-SS.names

# write.csv(SS.l_fits, "SS.l_fits.csv")


```

### non-linear fits
```{r}
#non-linear fits

ess.short.nl_fits<-ess.short.gam_glm %>%
                  dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05) #%>% dplyr::filter(r_sq>0.19)#%>% select(combo)

ess.long.nl_fits<-ess.long.gam_glm %>%
                 dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05) #%>% dplyr::filter(r_sq>0.19)#%>% select(combo)

wss.short.nl_fits<-wss.short.gam_glm %>%
                  dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05) #%>% dplyr::filter(r_sq>0.19)#%>% select(combo)

wss.long.nl_fits<-wss.long.gam_glm %>%
                  dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05) #%>% dplyr::filter(r_sq>0.19)#%>% select(combo)

ess.short.nl_fits_combo<-ess.short.gam_glm %>%
                  dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05)  %>% select(combo)

ess.long.nl_fits_combo<-ess.long.gam_glm %>%
                 dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05)  %>% select(combo)

wss.short.nl_fits_combo<-wss.short.gam_glm %>%
                  dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05)  %>% select(combo)

wss.long.nl_fits_combo<-wss.long.gam_glm %>%
                  dplyr::filter(!is.na(id)) %>%
                  dplyr::filter(p_val<0.05)%>% select(combo)

SS.nl_fits<-cbind.fill(ess.short.nl_fits_combo, ess.long.nl_fits_combo, wss.short.nl_fits_combo, wss.long.nl_fits_combo)

SS.names<-c("ess.short", "ess.long", "wss.short", "wss.long")
colnames(SS.nl_fits)<-SS.names

 write_csv(SS.nl_fits, "SS.nl_fits.csv")
```

### Useful/Useless inds
```{r}
# are there any indicators not responding to pressures?
  
ess.short.l_fits_ind<-distinct(ess.short.l_fits, ind.x)
ess.short.nl_fits_ind<-distinct(ess.short.nl_fits, ind.x)
ess.short.useful.ind<-full_join(ess.short.l_fits_ind, ess.short.nl_fits_ind)

ess.short.all.ind.x<-distinct(ess.short.gam_glm, ind.x) 

ess.short.useless.ind<- dplyr::anti_join(ess.short.all.ind.x, ess.short.useful.ind)

ess.long.l_fits_ind<-distinct(ess.long.l_fits, ind.x)
ess.long.nl_fits_ind<-distinct(ess.long.nl_fits, ind.x)
ess.long.useful.ind<-full_join(ess.long.l_fits_ind, ess.long.nl_fits_ind)

ess.long.all.ind.x<-distinct(ess.long.gam_glm, ind.x) 

ess.long.useless.ind<- dplyr::anti_join(ess.long.all.ind.x, ess.long.useful.ind)

wss.short.l_fits_ind<-distinct(wss.short.l_fits, ind.x)
wss.short.nl_fits_ind<-distinct(wss.short.nl_fits, ind.x)
wss.short.useful.ind<-full_join(wss.short.l_fits_ind, wss.short.nl_fits_ind)

wss.short.all.ind.x<-distinct(wss.short.gam_glm, ind.x) 

wss.short.useless.ind<- dplyr::anti_join(wss.short.all.ind.x, wss.short.useful.ind)

wss.long.l_fits_ind<-distinct(wss.long.l_fits, ind.x)
wss.long.nl_fits_ind<-distinct(wss.long.nl_fits, ind.x)
wss.long.useful.ind<-full_join(wss.long.l_fits_ind, wss.long.nl_fits_ind)

wss.long.all.ind.x<-distinct(wss.long.gam_glm, ind.x) 

wss.long.useless.ind<- dplyr::anti_join(wss.long.all.ind.x, wss.long.useful.ind)

SS.useless.inds<-cbind.fill(ess.short.useless.ind,ess.long.useless.ind,  wss.short.useless.ind, wss.long.useless.ind)

colnames(SS.useless.inds)<-SS.names

SS.useful.inds<-cbind.fill(ess.short.useful.ind,ess.long.useful.ind,  wss.short.useful.ind, wss.long.useful.ind)

colnames(SS.useful.inds)<-SS.names

##common useful inds


write_csv(SS.useless.inds, "SS.useless.inds.csv")
write_csv(SS.useful.inds, "SS.useful.inds.csv")
```

### Useful/Useless press
```{r}
# are there any pressures not responding to indicators?

ess.short.l_fits_press<-distinct(ess.short.l_fits, press.x)
ess.short.nl_fits_press<-distinct(ess.short.nl_fits, press.x)
ess.short.useful.press<-full_join(ess.short.l_fits_press, ess.short.nl_fits_press)

ess.short.all.press.x<-distinct(ess.short.gam_glm, press.x) 

ess.short.useless.press<- dplyr::anti_join(ess.short.all.press.x, ess.short.useful.press)

ess.long.l_fits_press<-distinct(ess.long.l_fits, press.x)
ess.long.nl_fits_press<-distinct(ess.long.nl_fits, press.x)
ess.long.useful.press<-full_join(ess.long.l_fits_press, ess.long.nl_fits_press)

ess.long.all.press.x<-distinct(ess.long.gam_glm, press.x) 

ess.long.useless.press<- dplyr::anti_join(ess.long.all.press.x, ess.long.useful.press)

wss.short.l_fits_press<-distinct(wss.short.l_fits, press.x)
wss.short.nl_fits_press<-distinct(wss.short.nl_fits, press.x)
wss.short.useful.press<-full_join(wss.short.l_fits_press, wss.short.nl_fits_press)

wss.short.all.press.x<-distinct(wss.short.gam_glm, press.x) 

wss.short.useless.press<- dplyr::anti_join(wss.short.all.press.x, wss.short.useful.press)

wss.long.l_fits_press<-distinct(wss.long.l_fits, press.x)
wss.long.nl_fits_press<-distinct(wss.long.nl_fits, press.x)
wss.long.useful.press<-full_join(wss.long.l_fits_press, wss.long.nl_fits_press)

wss.long.all.press.x<-distinct(wss.long.gam_glm, press.x) 

wss.long.useless.press<- dplyr::anti_join(wss.long.all.press.x, wss.long.useful.press)

SS.useless.press<-cbind.fill(ess.short.useless.press,ess.long.useless.press,  wss.short.useless.press, wss.long.useless.press)
colnames(SS.useless.press)<-SS.names

SS.useful.press<-cbind.fill(ess.short.useful.press,ess.long.useful.press,  wss.short.useful.press, wss.long.useful.press)

colnames(SS.useful.press)<-SS.names

write_csv(SS.useless.press, "SS.useless.press.csv")
write_csv(SS.useful.press, "SS.useful.press.csv")

```

### significant thresholds
```{r}
# Which significant thresholds were found?
ess.short.thresh<-ess.short.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)

ess.long.thresh<-ess.long.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)


wss.short.thresh<-wss.short.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)


wss.long.thresh<-wss.long.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)


ess.short.thresh_combo<-ess.short.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)%>% select(combo)

ess.long.thresh_combo<-ess.long.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)%>% select(combo)


wss.short.thresh_combo<-wss.short.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)%>% select(combo)


wss.long.thresh_combo<-wss.long.gam_glm %>% 
                  dplyr::filter(interaction== "TRUE", na.rm=TRUE)%>% select(combo)

SS.thresh<-cbind.fill(ess.short.thresh_combo, ess.long.thresh_combo, wss.short.thresh_combo, wss.long.thresh_combo)
colnames(SS.thresh)<-SS.names

# write_csv(SS.thresh, "SS.thresh.csv")

```

### Regional/SS continuity
```{r}
# Is there any continuity across long and short time series or regions
## Are there common linear fits?
ess.common.l_fits<-intersect(SS.l_fits$ess.short, SS.l_fits$ess.long) #no answers because ess.long had no l_fits
wss.common.l_fits<-intersect(SS.l_fits$wss.short, SS.l_fits$wss.long)

SS.short.common.l_fits<-intersect(SS.l_fits$ess.short, SS.l_fits$wss.short)

## Are there common non-linear fits?
ess.common.nl_fits<-intersect(SS.nl_fits$ess.short, SS.nl_fits$ess.long) 
wss.common.nl_fits<-intersect(SS.nl_fits$wss.short, SS.nl_fits$wss.long)
SS.short.common.nl_fits<-intersect(SS.nl_fits$ess.short, SS.nl_fits$wss.short)
SS.long.common.nl_fits<-intersect(SS.nl_fits$ess.long, SS.nl_fits$wss.long)

##common useful inds
ess.common.useful.inds<-intersect(SS.useful.inds$ess.short, SS.useful.inds$ess.long)
wss.common.useful.inds<-intersect(SS.useful.inds$wss.short, SS.useful.inds$wss.long)
SS.short.common.useful.inds<-intersect(SS.useful.inds$ess.short, SS.useful.inds$wss.short)
SS.long.common.useful.inds<- intersect(SS.useful.inds$ess.long, SS.useful.inds$wss.long)
SS.common.useful.inds<-intersect(SS.short.common.useful.inds, SS.long.common.useful.inds)

##common useless inds
ess.common.useless.inds<-intersect(SS.useless.inds$ess.short, SS.useless.inds$ess.long)
wss.common.useless.inds<-intersect(SS.useless.inds$wss.short, SS.useless.inds$wss.long)
SS.short.common.useless.inds<-intersect(SS.useless.inds$ess.short, SS.useless.inds$wss.short)
SS.long.common.useless.inds<- intersect(SS.useless.inds$ess.long, SS.useless.inds$wss.long)
SS.common.useless.inds<-intersect(SS.short.common.useless.inds, SS.long.common.useless.inds)

##common useful press
ess.common.useful.press<-intersect(SS.useful.press$ess.short, SS.useful.press$ess.long)
wss.common.useful.press<-intersect(SS.useful.press$wss.short, SS.useful.press$wss.long)
SS.short.common.useful.press<-intersect(SS.useful.press$ess.short, SS.useful.press$wss.short)
SS.long.common.useful.press<- intersect(SS.useful.press$ess.long, SS.useful.press$wss.long)
SS.common.useful.press<-intersect(SS.short.common.useful.press, SS.long.common.useful.press)

##common useless pressures
ess.common.useless.press<-intersect(SS.useless.press$ess.short, SS.useless.press$ess.long)
wss.common.useless.press<-intersect(SS.useless.press$wss.short, SS.useless.press$wss.long)
SS.short.common.useless.press<-intersect(SS.useless.press$ess.short, SS.useless.press$wss.short)
SS.long.common.useless.press<- intersect(SS.useless.press$ess.long, SS.useless.press$wss.long)
SS.common.useless.press<-intersect(SS.short.common.useless.press, SS.long.common.useless.press)


##common thresholds?
ess.common.thresh<-intersect(SS.thresh$ess.short, SS.thresh$ess.long)
wss.common.thresh<-intersect(SS.thresh$wss.short, SS.thresh$wss.long)
SS.short.common.thresh<-intersect(SS.thresh$ess.short, SS.thresh$wss.short)
SS.long.common.thresh<- intersect(SS.thresh$ess.long, SS.thresh$wss.long)
SS.common.thresh<-intersect(SS.short.common.thresh, SS.long.common.thresh)

SS.common.thresh.info<-cbind.fill(ess.common.thresh, wss.common.thresh, SS.short.common.thresh, SS.long.common.thresh, SS.common.thresh)
SS.common.names<-c("ess.common.thresh", "wss.common.thresh", "SS.short.common.thresh", "SS.long.common.thresh", "SS.common.thresh")

colnames(SS.common.thresh.info)<-SS.common.names

# write_csv(ess.common.thresh, "ess.common.thresh.csv")
# write_csv(wss.common.thresh, "wss.common.thresh.csv")
# write_csv(SS.short.common.thresh, "SS.short.common.thresh.csv")
# write_csv(SS.long.common.thresh, "SS.long.common.thresh.csv")
# write_csv(SS.common.thresh, "SS.common.thresh.csv")
write_csv(SS.common.thresh.info, "SS.common.thresh.info.csv")


```

### Count of useful indicators
```{r}
#for each region/timeseries, how many times is a indicator/pressure useful? 

##combine l and nonlinear
ess.short.useful_fits<-rbind(ess.short.l_fits, ess.short.nl_fits)

ess.short.uf<-ess.short.useful_fits %>% 
              count(ind.x)

hist_ind_ess.short<-ggplot(data.frame(ess.short.uf), aes(x=reorder(ind.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="ESS short", y="", x="Ecological Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

wss.short.useful_fits<-rbind(wss.short.l_fits, wss.short.nl_fits)

wss.short.uf<-wss.short.useful_fits %>% 
              count(ind.x)

hist_ind_wss.short<-ggplot(data.frame(wss.short.uf), aes(x=reorder(ind.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="WSS short", y="", x="Ecological Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

ess.long.useful_fits<-rbind(ess.long.l_fits, ess.long.nl_fits)

ess.long.uf<-ess.long.useful_fits %>% 
              count(ind.x)

hist_ind_ess.long<-ggplot(data.frame(ess.long.uf), aes(x=reorder(ind.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="ESS long", y="", x="Ecological Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

wss.long.useful_fits<-rbind(wss.long.l_fits, wss.long.nl_fits)

wss.long.uf<-wss.long.useful_fits %>% 
              count(ind.x)

hist_ind_wss.long<-ggplot(data.frame(wss.long.uf), aes(x=reorder(ind.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="WSS long", y="", x="Ecological Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

grid.newpage()

jpeg(filename="SS_hist_useful_inds_count.jpeg", width=10, height=10, units="in", quality=100,res=600)
grid.arrange(hist_ind_ess.short, hist_ind_wss.short,hist_ind_ess.long, hist_ind_wss.long, ncol = 2)

dev.off()


```

### Count of useful pressures
```{r}
#histogram for each pressures 
ess.short.useful_fits<-rbind(ess.short.l_fits, ess.short.nl_fits)

ess.short.ufp<-ess.short.useful_fits %>% 
              count(press.x)

hist_press_ess.short<-ggplot(data.frame(ess.short.ufp), aes(x=reorder(press.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="ESS short", y="", x="Pressure Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

wss.short.useful_fits<-rbind(wss.short.l_fits, wss.short.nl_fits)

wss.short.ufp<-wss.short.useful_fits %>% 
              count(press.x)

hist_press_wss.short<-ggplot(data.frame(wss.short.ufp), aes(x=reorder(press.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="WSS short", y="", x="Pressure Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

ess.long.useful_fits<-rbind(ess.long.l_fits, ess.long.nl_fits)

ess.long.ufp<-ess.long.useful_fits %>% 
              count(press.x)

hist_press_ess.long<-ggplot(data.frame(ess.long.ufp), aes(x=reorder(press.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="ESS long", y="", x="Pressure Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

wss.long.useful_fits<-rbind(wss.long.l_fits, wss.long.nl_fits)

wss.long.ufp<-wss.long.useful_fits %>% 
              count(press.x)

hist_press_wss.long<-ggplot(data.frame(wss.long.ufp), aes(x=reorder(press.x, n), y=n))+
                          geom_bar(stat="identity")+
                          #geom_text(aes(label=n), color="white")  +
                          labs(title="WSS long", y="", x="Pressure Indicator")+
                          theme(axis.text.x=element_text(angle=90))+
                          coord_flip()

grid.newpage()

jpeg(filename="SS_hist_useful_press_count.jpeg", width=10, height=10, units="in", quality=100,res=600)
grid.arrange(hist_press_ess.short, hist_press_wss.short,hist_press_ess.long, hist_press_wss.long, ncol = 2)

dev.off()

```

```{r}
#refer to danielle's results for MAFA and DFA. S
```

